# Исправление проблемы продажи акций

## Первая проблема: Неправильная обработка callback_data
При попытке продать акцию LKOH пользователь получал ошибки:
- "Акция custom_LKOH не найдена в портфеле"
- "Акция auto_LKOH не найдена в портфеле"

### Причина
Общий обработчик callback_data, начинающихся с "sell_", был определен ПЕРЕД специфичными обработчиками "sell_auto_" и "sell_custom_".

### Исправление
1. Перемещен общий обработчик ПОСЛЕ специфичных
2. Добавлена дополнительная защита в общий обработчик

## Вторая проблема: Потеря данных состояния при пользовательской цене
После исправления первой проблемы возникла новая ошибка:
- После ввода пользовательской цены: "❌ Идея не найдена. Начните заново с /ideas"

### Причина
Функция `sell_custom_price` использовала `await state.update_data(custom_sell_ticker=ticker)`, что **полностью перезаписывало** данные состояния и удаляло ранее сохраненные `sell_quantity`, `avg_price` и другие поля.

### Исправление
Изменена логика сохранения данных в функции `sell_custom_price`:

**БЫЛО (неправильно):**
```python
await state.update_data(custom_sell_ticker=ticker)
```

**СТАЛО (правильно):**
```python
data = await state.get_data()
data['custom_sell_ticker'] = ticker
await state.update_data(**data)
```

### Добавлено отладочное логирование
Для диагностики проблем добавлено подробное логирование в функции:
- `sell_custom_price` - логирует данные до и после сохранения
- `process_custom_sell_price` - логирует полученные данные и путь обработки

## Результат
Теперь продажа акций по пользовательской цене должна работать корректно:
- ✅ Данные состояния сохраняются
- ✅ Правильный путь обработки (продажа, а не покупка)
- ✅ Все необходимые поля доступны для выполнения операции

## Отладка
Если проблема повторится, проверьте логи на предмет записей:
- `sell_custom_price - Данные ДО/ПОСЛЕ добавления custom_sell_ticker`
- `process_custom_sell_price - Обрабатываем как ПРОДАЖУ/ПОКУПКУ`
